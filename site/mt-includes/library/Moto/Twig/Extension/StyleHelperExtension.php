<?php
namespace Moto\Twig\Extension; use Moto; class StyleHelperExtension extends AbstractExtension { protected $_name = 'motoStyleHelper'; public function getGlobals() { return array( 'StyleHelper' => $this ); } public function getFunctions() { return array( new \Twig_SimpleFunction('generateLessFromArray', array($this, 'generateLessFromArraySafe'), array( 'is_safe' => array( 'html', ), ) ), new \Twig_SimpleFunction('generateWidgetInlineStyles', array($this, 'generateWidgetInlineStyles'), array( 'is_safe' => array( 'html', ), ) ), new \Twig_SimpleFunction('generatePresetSelector', array($this, 'generatePresetSelectorSafe'), array( 'is_safe' => array( 'html', ), ) ), ); } public function generateLessFromArray($property, $class = null) { return new \Twig_Markup($this->generateLessFromArraySafe($property, $class), 'UTF-8'); } public function generatePresetSelector($widgetClassName, $presetClassName = null) { return new \Twig_Markup($this->generatePresetSelectorSafe($widgetClassName, $presetClassName), 'UTF-8'); } public function generateLessFromArraySafe($property, $className = null) { $result = ''; if (empty($property)) { return $result; } if (is_string($property)) { if (is_string($className)) { $result .= $className . " {\n"; } $result .= $property; if (is_string($className)) { $result .= "\n}\n"; } return $result; } $property = (array) $property; foreach($property as $name => $value) { if (empty($value)) { continue; } if ($name === 'base') { $result .= $this->generateLessFromArraySafe($value); continue; } if ($name === 'before' || $name === 'after' || $name === 'hover') { $code = $this->generateLessFromArraySafe($value); if (!empty($code)) { $result .= '&:' . $name . " {\n"; $result .= $code; $result .= "}\n"; } continue; } if (is_array($value)) { if (array_key_exists('unicode', $value) && is_string($value['unicode'])) { $value['unicode'] = ltrim($value['unicode'], '\\'); $result .= $name . ':"\\' . $value['unicode'] . '";' . "\n"; } continue; } if (is_object($value)) { continue; } $result .= $name . ':' . $value . ';' . "\n"; } if (is_string($className) && !empty($result)) { $result = $className . " {\n" . $result . "}\n"; } return $result; } public function generateWidgetInlineStyles($styles) { if (is_string($styles)) { return $styles; } $styles = (array) $styles; $result = ''; foreach ($styles as $name => $value) { if (is_string($value) && empty($value)) { continue; } if ($name === 'background-image') { if ($this->isPreRenderMode()) { $value = 'url({{ Linker.img(\'' . $value . '\') }})'; } else { $value = 'url(' . Moto\System::getUploadUrl($value) . ')'; } } if (!is_string($value) || empty($value)) { continue; } if ($name === 'background-color' && $value[0] === '@') { continue; } if ($name === 'color' && $value[0] === '@') { continue; } $result .= $name . ':' . $value . ';'; } return $this->_returnTemplate($result); } public function generatePresetSelectorSafe($widgetClassName, $presetClassName = null) { $result = ''; if (!is_string($widgetClassName)) { Moto\System\Log::error('StyleHelper.generatePresetSelector: argument "$widgetClassName" should be a string:', array( '$widgetClassName' => $widgetClassName, '$presetClassName' => $presetClassName, ) ); return $result; } $result = $widgetClassName; if (!is_string($presetClassName)) { $presetClassName = Moto\Util::getValue($presetClassName, 'class_name', ''); } if (is_string($presetClassName) && !empty($presetClassName)) { $result .= '.' . $presetClassName; } return $result; } } 